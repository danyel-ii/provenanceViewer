# cubixles_ Provenance Viewer (Read-only)

A read-only, off-chain provenance viewer for NFTs minted on the CUBIXLES_CONTRACT. The app inspects metadata, mint transactions, and ownership overlap to infer relationships without ever signing or writing on-chain.

## Requirements
- Node.js 18+
- Alchemy API key
- CUBIXLES contract + network env vars

## Setup
```bash
npm install
npm run dev
```

If you hit npm cache permission issues, use `npm install --cache .npm-cache`.

Copy `.env.example` to `.env.local` and fill in values:
- `ALCHEMY_KEY` (or `ALCHEMY_API_KEY`)
- `CUBIXLES_CONTRACT` (or `CUBIXLES_CONTRACT_ADDRESS`, mainnet: `0xA72EBf7F8d9Bc4ec5aDF1fFcDF32dfeD0b06F64C`)
- `NETWORK` (or `CUBIXLES_CHAIN_ID`/`BASE_CHAIN_ID` for auto-mapping)
- Optional: `CUBIXLES_BASE_CONTRACT_ADDRESS` (Base: `0x4130F69f396f5478CFD1e1792e2970da4299383a`)
- `NEXT_PUBLIC_BASE_PATH` (default `/inspecta_deck` for subpath deployments)
- `NEXT_PUBLIC_BASE_URL` (optional absolute URL for metadata/linking; include the base path if hosting under a subpath, e.g. `https://www.cubixles.xyz/inspecta_deck`)

Optional caching and rate limits:
- `CACHE_PROVIDER` (`memory`, `redis`, `kv`)
- `REDIS_URL`
- `CACHE_TTL_*`
- `READ_RATE_LIMIT`, `READ_RATE_WINDOW_SECONDS`
- `VERIFY_RATE_LIMIT`, `VERIFY_RATE_WINDOW_SECONDS`
- `KV_REST_API_URL`, `KV_REST_API_TOKEN`
- `HELPDESK_RATE_LIMIT`, `HELPDESK_RATE_WINDOW_SECONDS`
- Distributed rate limiting uses `REDIS_URL` first, then Vercel KV when `KV_REST_API_URL` + `KV_REST_API_TOKEN` are set (otherwise falls back to in-memory).

Optional metadata fetch safety:
- `METADATA_ALLOWED_HOSTS` (comma/space-delimited allowlist)
- `METADATA_FETCH_TIMEOUT_MS`
- `METADATA_MAX_BYTES`
- Defaults to IPFS/Arweave gateways and blocks private/loopback hosts.

Optional CSP and framing:
- `FRAME_ANCESTORS` (space-delimited origins for `frame-ancestors`)
- `CSP_REPORT_MAX_BYTES`, `CSP_REPORT_RATE_LIMIT`, `CSP_REPORT_RATE_WINDOW_SECONDS`

Optional helpdesk LLM configuration:
- `HELPDESK_MAX_BODY_BYTES`
- `HELPDESK_LLM_API_KEY` (or `OPENAI_API_KEY`)
- `HELPDESK_LLM_BASE_URL`, `HELPDESK_LLM_MODEL`
- `HELPDESK_LLM_MAX_TOKENS`

Optional mint audit enrichment:
- `ALCHEMY_API_KEY` + `CUBIXLES_CONTRACT_ADDRESS` (used by `/m/[tokenId]` metadata lookups)
- `CUBIXLES_CHAIN_ID` (selects the v2 Alchemy base for mint audit; default 1)
- `MAINNET_RPC_URL` (enables `alchemy_getAssetTransfers` on mainnet)

Optional helpdesk KB upkeep:
- `node scripts/kb_build.mjs` to rebuild `kb/index.jsonl`
- `node scripts/kb_embed.mjs` to generate `kb/vectors.json` for semantic search

## API endpoints
- `GET /api/poc/tokens?limit=&pageKey=&all=true&maxPages=`
  - Proof-of-concept list of tokens from CUBIXLES_CONTRACT.
  - Use `pageKey` for pagination; `all=true` aggregates pages (capped by `maxPages`).
- `GET /api/token/:id`
  - Token metadata + mint info (read-only).
- `GET /api/token/:id/provenance`
  - Heuristic provenance candidates with confidence + evidence.
- `POST /api/token/:id/verify`
  - Read-only verification (ownerOf + tokenURI). Rate limited.
- `POST /api/help`
  - RAG helpdesk endpoint (returns answer, citations, confidence).
- `POST /api/csp-report`
  - CSP report collector (rate limited, returns 204).

## Frontend routes
All routes are served under `NEXT_PUBLIC_BASE_PATH` when configured (default `/inspecta_deck`).
- `GET /` or `GET /landing`
  - Landing page + live token list.
- `GET /token/[id]`
  - Token viewer that renders metadata, provenance candidates, and verification UI.
- `GET /m/[tokenId]`
  - Mint audit view (uses optional enrichment if configured).
- `GET /help`
  - Helpdesk UI with citations.

## Limits and assumptions
- Provenance is heuristic and can be incomplete.
- Only tokens from `CUBIXLES_CONTRACT` are valid.
- No wallet connections, signing, or on-chain writes are permitted.
- Metadata is resolved through IPFS/Arweave gateways and cached with TTLs.
- Public read endpoints are rate limited per client IP (configurable with `READ_RATE_LIMIT`).

## Signature
```
f---------------------------------------------------------------------------------------------------
r-+#*#****+##*#**#***+#***+#+**+#+++=+=+-=--=-------------------------------------------------------
e-#@@@@@@@%%%%%%%%#%##%#%%*#*####***++=+===------==--===-=-=-=-==-=-===-===========+=+=++++++=*+*=--
e-#@@@@%%@%%%##%#*#*##**+**+*+++=======-----+#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%###*+==--
p-*@@%@%%@*#%+##=+#=++=*=+=-====-------=---##@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%#*%@%@@@@@@+--
a-*%@%%%%%***++==++==----------------------%%@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@%#@%@%%%@%*--
l-*%%%%%##*++=====-------------------------@%@@%%@@@%%##################%%%%@@%%%%#@@@@%#@%@%@%@@+--
e-*#@#%%*#==+-==------------------------=--@#@@*@@-==+===============---=-=---==+@@#@%@%#@%@%%%@%+--
s-*%%###+*+==---------------======---------%#@@*@*-=++========+%**--------++=-==-#@#@@@%#@%@%%%@@+--
t-+**#+*+==----=-------+##%@@@@@@@@@%#+==--*##%*%*-=====------*%%%*+=--=+#%*#+-==#%#@%@%#@%@%%@@@*--
i-****=+=-----------+@##%##%@@@%***#%@@@@@@@%++=#+-=====------+%*#**%%@%%@%%#=-=-#%#@@@%#@#@%@%@@+--
n-+*+===----------*#+*##%@@@@@@@%#**%@@@#@@%%%@#+=-=----=+=----#*++-----=#*#*--==#%#@@@%#@#@%%@@@+--
e-=+==----------*#*%@%%***#%@@@@@@@##%@@@@@@@%#%@#----*#+===#+-+%+*=----##*%=--==#%#@@@%%@#@%%@@@*--
f-===----------%#@@@@%#*++*#*#@@@@@@@@@@@@@@@@%%@@@+-%%#+=-+=#=-#%*%+--%**%+---==#%#@@@%%@%@%%@@@+--
r---=----=----+@%@@@@@@@@@%@%%**%#%%@@@@@@@@@%%@@@@@@*+@%#+====#+-*%*#%#+*#=--====#%%@%%%%@#@@%@@@*--
e-------=----+@@@@@@@@@@@@@@@@%%+=+*###%@@%%%%%*#%@%%@%*%%*+***##--*%*++#%==+=====%%#*#%#%@#@@@@@@+--
e-------=---+@@@@@@@@@@@@@@@@@@@@%*+=*==++*++%@@##*+*#@%+#%#**%%=---#%*#@=-======-%%%@@@%#@#@@@@@@+--
p----------=@@@@@@@@@@@@@@@@@@@@@%@@#%%##@%###+%@@@@%@@@%+*#%%#=-==-#%**%--======-%%#@@@%%@#@@@@@@*--
a---------=@@@@@@@@@@@@@@@@@@@@@@@%#@@@@*@@@%==+%@%%@@@@%%=++=-==-=-##+*%--======-%%####%%@#@@@@@@+--
l--------=%@@@@@@@@@@@@@@@@@@@@@@*#@@@%*#@@#---=#@*+%@@@@%*-=====---##+#@-=======-%#%%#@%%@#@@@@@@+--
e-------=%@%%@@@@@@@@@@@@@%%@@#*#@@@#++*@@*----=%%==*@@@@#%-=======-%%*#%========-%#%@@@%%@%@@@@@@+--
s------+@@%%@@@@@@@@@@@**#*++#@@@*++==#%+---=--=#=--+@@@@##-========%###%=-=======%#%@%@%%@%@@%@@@+--
t-----+#%%@@@@@@@@@@@%**#%@@%%*+===-=+=-===-=----=*%%@@@%+-==-======#%#%%=-======-%#%@@@%%@%@@@@@@+--
i----**@@@@@%#%#+%@@@#*#**##%@@@@%*+---+++++-=*%@@@%%@@@#=====---==-=+**=-========%#%@@@#%@%@@%@@@+--
n---*+%@@@@@*%@@@@@@@#**#%@@@%%%@@@@@@#+==+%@@@##***#@@@#==++**####%%##*++==----=#@#%@@@#%@%@@%@@@+--
e--==@@@@@@@*#*@@@@@%*+++##+@@@%+#@#**+=-=#@@@@@=*%+%@@@@++#%@@@@%##****####%%%%@@@*@@@@#%@%@@@@@@+--
f--=@@@@@@@@#*#@%#@@%*++=+#**#*+-=+*+++===+#+##++#+=%@@@%@++####%%%@@@@@@@@@@@@@%%%@@@@@#%@%@@@@@%=--
r--+@@%@@@@@@***@#%%%*++===+#%##*=---==+===-+*#%*===@@@@#****%@@@@@@@%##**#%@@@@@@@@@@@@#%@@@@@%#*+--
e--+@@#%@@@@@%***#****+++=---===----+++==+*+-=+=---+@@@@@#-=+*###%%%%%%@@@@@@@@@@%#***##*@@@@%#@@@*--
e---#@*%@@@@@@@@%@%*####*+==-------+%@@%#%%%-------%@@@@@@*==+++**+****####%%@@@@@@%#%@@@@@@@@@@@%+--
p----+*#@@%@@@@@@@+**=+#+=%*==------+*%@@#=-------+@@@@@%@@====+=====+===+====+*#%@@#*@@@@@%%%%%%#+--
a---==--*@@+%@@@@##%++#=-==+*=--------===--------+@@@@@@%*%-========++**##%@%%#%%*+++++********#*+=--
l---==---=++*@@@@#%*+#+=-+#+%==--=*##%#####*----+@@@@@@@**+-+%%%%####*******+**+++***###*+++==+=+=---
e----=---=#@@@@@%##+*+=--==%@#+=--=-=+***=----+@@@@@%@@#=---*#*+*#@%*+++**++++++###%%#*+==++#==+==---
s---=--=#@%%@@@@%##***+=------=##+==+=====--+%@@@@@%@%@+-==-*#@@@@@%##%%%%%#**+==+++++=----*#=====---
t--=--*@@@%%%%@@@@%#****++=------+#+======*@@@@@@@%*+#@@*===*#%#%%%@@@@@@%++===+=+=++*=++--*#=+=++---
i----%%#%@@@@@@@%@@@@#****++==-----#@##%@@@@@%##@@%*#@@*%===*#%*%****@@@@%++-+#+-**#+**%=--*#++==+=--
n---%@@@%%@@%#%@@@@@@@@@#***++==---*@@@@@@%@%#*@@@*%*+#+*#-=##%%#**##**#@%++-++#+**+++=+---*#+=++==--
e--*@@@@###%@%#@%%@@%%@@@@%#**+=---#@%%@@##+@@@++#@%+%@+=%+=###*%%#@@%%%%%+++++--+#+++=#*+**#+=++==--
f--%@@@@%%*%@@@@@%%@@@@@@@****+=--=%@@%*+%+*@@%++@@#%@%#@@@=*##*#+**###%@%++**=#**#=%#=###++#++=+==--
r-=%@#*#@@@%+*%@%%@%%@@@@#**+=----*@%*#%@@@#*#%%%%%%%#=*@@@**#%@@@%%*###*%++*#**+++=--==+*-*#+++*+=--
e-=%@###@@@@+++%@%#@%@@@#**+=----=@@@#**@@%*+#@@#%@@#+*##++%##%@%%%#%@@%%%++=--=+*#%@@@@@@-*#+++++=--
e-=@@@@@##++%@@%@@%@@@@%*++==----#%%%%%%%%%%%%%%#@@@%@@@%+=*##@@@#%@@@@@@%++*@@@@%+++*%@@@-*#+=*++=--
p-+%%@@@#+*#%@@@%#%@@@%++*==----+@#%@@@*+*@@@#+%@@%#%@@%#%%%##%@@*%#%@@@@%++*@@##*+===+*@@=*#+*+++=--
a-=%%@%#@@@@%*#%@%%@@%+++==-----#@%@@@#+*@@@@*#@@@%%@%*+=#@#####@##*#@@@@%++*@%%+++===++#@-*#**+*+=--
l-=%@##*@@@@@#%%%@%%%*++==-----+@@%**#@@%**+@@%@@%@@@@**%@==*#####%@@@@@@%++*@%%%%*##+=+#@-*#+*#**=--
e-=%@%#%@*###@@@@#*@#*++=------#@@#*#@@@##*%@@%@@#@@%#@@@@#=*##@%##*+#*##%++*@@#**=+===%%@-*#*%%%%+--
s-=%@%@@@%%@%%@@@#@@%**+=-----=%%@@@###@@@@%%@@%@@@%%%@##*#####@@@@@@@%%%%++*@@#*#++==+#@@=*%#%%%%+--
t-=%%%@@@@@%%@@@@@@@%%*+------*@@@@%##%@@@@@@@@%@@@@@@@@@@#####@@@@@@@@@@%++*@@#%*===+*##@=*%%%@@@*--
i-=%%%%%@@@@@%#@#+#@*+%*==----%@@%@@@@%@@@@@%##@@@@#+=+%@#++###@@@@@@@@@@%++*@@@%*+*#*=+*%-*%%@@@@*--
n-+@@@%@@%@@%%*%+++#*=-+%%#=-*@@@@@@%#*%%%%%+=-=#%#**%@@@%#+###@@@@@@@@@%%++*@@@@@%%#+===*-*@@@@@@+--
e-+@@@@@%%%@@%@@#=#@@%=+@@@@%*+*#=+#%===#@%#*@@@@*===#@@@%==*#%@@@@@@@%@@%++*@@@@%@%+=+*==-*%%@@@@+--
f-+@@@%@%%@@@@@@@%@@@@@#%@@@*=+%+-=+%@%%%*--=#@@@%**#%%*++@*##%@@@@@@@@@@%++*@@%%#%++**+++-*#+****=--
r-+%@@#@@@%%@#@@%++%@@*--=+#%%@#=--+*@@@@%++*#*+++%@@@%===++##%@@@@@@@@%@%++*@%%##+**#**++-*#+++++=--
e-+%@@@@@@%%@##@+===+#=---#@@@%+=+++*%*==+%@@@*===#%%#++*%@@@#%@@@@@@@@@%%++*@#%#*++#*#=++=*@@#++==--
e-+%%@@@%@@#%%%@%+==#%@@%*%%%@*****##%#+++#@%#***##%%%%%%%%%@#%@@@@@@@@@@%++*@%@%+#####*#*=*#***#%+--
p-+@@@@@@%#@@@@@@@#%@@@@%+=*@@@@@@@@@%###%%%###*#####%%%%%%@@#%@@@@@@@@@@%++*@%@*##*%#*+===*#++===---
a-=%%%@@@@@@@@@@@%++*@@%++#@@@@%%%%%@@#+********++***###%%%@@%%@@@@@@@@@@%++*@@%*+=====+==+##======--
l-=##%%%%@@@@@%##+****%@@@%%##%##*#%@%####*+++=++==++++**#%%%@@%%%@@@@@@@%++====+====+###*+=====+*=--
e-=******#*#%%@@@@@@@@@%##****++*+#%@%@@@@%#**%#=====++=++++*###@@%%%@@@@%++====*#%#+++===+=+#%**%+--
s-=+++**+++*++**++**+=+++=+++==++=#%@#@%%%%%%@@#*#@%*+++==+++=++++*#%@%###+*#@#*======+=+%%**%@%%*=--
t-=%%*+===+===+============++++**#%%@#@%#######%%@@%#####*+========+==+++*+==+====+*#####%@#***+++=--
i-+%%%%%%*=--===-=====++==+++**#%%@%@#@%###*#*#*###%%@@@%#*#%#+=======++=+==+=*%#+*%%%#***+++++=++=--
n-=#%%%%%%%@%+=--=====+===+++*#%%@@%@#@%%##*********####%%@@@#+#@%*+====++*%#+*%@%**+*++++==+=++++---
e-=%@@@%#%%%%%%%#+====+===+++*##%@@@@%%@%%##*#*******#*#####%%@@@%###%#####%%***++=++++=+=++++++**=--
f-=%@@@@@@@%%%%%%%%%*=======++++*%%%@@@@##@%%##***#***#****####%%%@@@@@%#*+++++++=++==+++++++*##*#+--
r-=%@@@@@@@@@@%@%%%%%%%%+=--=+==+++*###%%@@%*%%%##**#***#*#***###%%@%++++++=+==+===++++++*##**%%*+=--
e-=%@@@@@@@@@@@@@%%%%%%%%%%#+=======+++*###%@@@%#%%%####***#*#*###%@*++==+==+=+=+++++*####%##++==+---
e-=%@@@@@@@@@@@@@@@@@%#%%%#%%%%#==-=++==++=+####@@@%*%@###%########%+===+=++=++*+*%%**%%*+=======+---
p-=%@%@%%@@@%@%@%@%@@@@@%#%%%%%%%%%+==-=+===++++###%@@@##%%%%%####%%+++++++++*#%#+#@#*+====+======---
a-=%@%@%%@@@%%%%%%%@@@@@@@@@%%%%%%%%%%#+-=-====+==+**#%%@@%##%@%%%%@*++++*##*##%%*++===========-=*=--
l-=%@%@%%@@@@@@%%%%%%%%%@@@@@@@@#%#%#%%%%%*=-=====++==**+*%%%@%*#@@%%*#%*+%@%#+====+==+====-=#%%##=--
e-=%@%@%%@@@@@@@@@%%%%%%%%@@@@@@@@@%%%%%%%%%@#+=--=====+==++++#%%@#*#**%%#*=++===========*%%##****=--
s-=#@%@#%%%@@@@@@@@@@@%%%%%%%%%@@@@@@@%%#%%%%%%%%#+--========+++=++*##*+=============*%%#*#*#*#*#%+--
t-=#@#%##%%@@@@%@@@@@@@@@%%%%%%%%%@%@@@@@@%%%#%%%#%%%*=--=+=-=+=-====+==+==+====-+%%##*#*##*##@@@%+--
i-=#@#%##%%@%%%%@@@%@@@@@@@@%%%%%%%%%@%@@@@@@@%%###%#%%@#+==--===============+#%###*#*##*#%@@%%###=--
n-=#@*%*#%%@%%%%@@%%@@%%%%%@@@@%%%%%%%%@%%%@@@@@@%##%%%#%%%%*=-==========+##%****#*#*#%@@@%%###*#*=--
e--*%*%*#%#%%%%%@@@@@@@%####%%@@@@%%%%%%#%%%@%%@@@@@%#%#%#%#%%%%+=====*%###***#***#@@%@%%%*####*#+=--
f--+#+#**%*%###%@@@@@@@@%#%@@@@%%@@@@%%%%%%%%%%@%@%%@@@@%%#%%%#%%%%#%##**#*#**#%@@%%%#%##***+*+*++=--
r--=++*+*#*##*##@%%@@%#++%@@@@@%#%@@@@@@@%%#%%%%#%%%%%@%@@@%%%%%%#%**+*****%%@@%####**#**++*++++==---
e-----=-=======+**+**+=+==*###**######%%#%%#***++*+#*##*###**##*++#+==+=*##*#***+*+=+========+-==----
e----------------------------------------------------------------------------------------------------
```
